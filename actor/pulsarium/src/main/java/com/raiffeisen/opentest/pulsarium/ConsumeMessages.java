package com.raiffeisen.opentest.pulsarium;

import com.raiffeisen.opentest.pulsarium.core.PulsariumTestAction;
import com.raiffeisen.opentest.pulsarium.util.connection.Consumers;
import org.apache.pulsar.client.api.Consumer;
import org.apache.pulsar.client.api.Message;

import java.util.ArrayList;
import java.util.List;

public class ConsumeMessages extends PulsariumTestAction {
    @Override
    public void run() {
        super.run();

        String consumerName = readStringArgument("consumerName");
        int consumingStopLength = readIntArgument("consumingStopLength");

        Consumer<Object> consumer = Consumers.map.get(consumerName);
        List<String> messages = new ArrayList<>();

        for (int i = 0; i < consumingStopLength; i++) {
            Message result = null;
            try {
                result = consumer.receive();
                messages.add(result.getValue().toString());
                consumer.acknowledge(result);
            } catch (Exception e) {
                consumer.negativeAcknowledge(result);
            }
        }

        writeOutput("consumedMessages", messages);
    }
}
