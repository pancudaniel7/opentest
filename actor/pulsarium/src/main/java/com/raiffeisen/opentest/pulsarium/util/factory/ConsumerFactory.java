package com.raiffeisen.opentest.pulsarium.util.factory;

import com.raiffeisen.opentest.pulsarium.exception.PulsariumConfigException;
import com.raiffeisen.opentest.pulsarium.util.connection.Consumers;
import lombok.AccessLevel;
import lombok.NoArgsConstructor;
import org.apache.pulsar.client.api.Consumer;
import org.apache.pulsar.client.api.PulsarClient;
import org.apache.pulsar.client.api.PulsarClientException;
import org.apache.pulsar.client.api.Schema;

import java.util.List;
import java.util.Map;

@NoArgsConstructor(access = AccessLevel.PRIVATE)
public class ConsumerFactory extends PulsarFactory {

    public static void createConsumer(List<Map<String, Object>> consumerConfig, PulsarClient client) {

        for (Map<String, Object> consumerConfigMap : consumerConfig) {

            Schema schema = getSchemaFrom(consumerConfigMap);
            String consumerName = consumerConfigMap.get("consumerName").toString();

            removeCustomProperties(consumerConfigMap);

            try {
                if (Consumers.map.containsKey(consumerName)) {
                    Consumers.map.get(consumerName).close();
                }

                Consumer<Object> consumer = client.newConsumer(schema)
                        .loadConf(consumerConfigMap)
                        .subscribe();

                Consumers.map.put(consumer.getConsumerName(), consumer);
            } catch (PulsarClientException e) {
                throw new PulsariumConfigException("Fail to create Pulsar consumer," +
                        " check if Pulsarium consumer configs are set correctly ", e);
            }
        }
    }
}
