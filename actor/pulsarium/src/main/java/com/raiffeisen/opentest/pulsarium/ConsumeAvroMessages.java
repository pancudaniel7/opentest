package com.raiffeisen.opentest.pulsarium;

import com.raiffeisen.opentest.pulsarium.core.PulsariumTestAction;
import com.raiffeisen.opentest.pulsarium.util.connection.Consumers;
import com.raiffeisen.opentest.pulsarium.util.transformer.AvroRecordTransformer;
import org.apache.pulsar.client.api.Consumer;
import org.apache.pulsar.client.api.Message;
import org.apache.pulsar.client.impl.schema.generic.GenericAvroRecord;

import java.util.ArrayList;
import java.util.List;
import java.util.Map;
import java.util.stream.Collectors;

public class ConsumeAvroMessages extends PulsariumTestAction {

    @Override
    public void run() {
        super.run();

        String consumerName = readStringArgument("consumerName");
        int consumingStopLength = readIntArgument("consumingStopLength");

        Consumer<Object> consumer = Consumers.map.get(consumerName);
        List<GenericAvroRecord> messages = new ArrayList<>();

        for (int i = 0; i < consumingStopLength; i++) {
            Message result = null;
            try {
                result = consumer.receive();
                messages.add((GenericAvroRecord) result.getValue());
                consumer.acknowledge(result);
            } catch (Exception e) {
                consumer.negativeAcknowledge(result);
            }
        }

        List<Map<String, Object>> stringMessages = messages.stream().map(AvroRecordTransformer::toMap).collect(Collectors.toList());
        writeOutput("consumedMessages", stringMessages);
    }
}
