package com.raiffeisen.opentest.pulsarium;

import com.raiffeisen.opentest.pulsarium.core.PulsariumTestAction;
import com.raiffeisen.opentest.pulsarium.exception.PulsariumProducerException;
import com.raiffeisen.opentest.pulsarium.util.connection.Producers;
import org.apache.pulsar.client.api.Producer;
import org.apache.pulsar.client.api.PulsarClientException;

import java.util.List;

import static java.lang.String.format;

public class SendMessages extends PulsariumTestAction {
    @Override
    public void run() {
        super.run();

        String producerName = readStringArgument("producerName");
        List<String> messages = readArrayArgument("messages", List.class);

        Producer<Object> producer = Producers.map.get(producerName);

        messages.forEach(message -> {
            try {
                producer.send(message);
            } catch (PulsarClientException e) {
                throw new PulsariumProducerException(format("Fail to sent message: %s for producer: %s", message, producerName), e);
            }
        });
    }
}
